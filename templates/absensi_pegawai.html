{% extends "base.html" %}
{% block title %}Absensi Pegawai{% endblock %}

{% block content %}

    <!-- Tambahkan Bootstrap CSS & Icons (Jika ini adalah template Jinja2 terpisah yang tidak mewarisi dari base.html) -->
    <!-- Biasanya base.html sudah mencakup ini, tapi kita tambahkan untuk memastikan style badge terlihat -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <div class="container mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center mb-4">
            <h3 class="fw-bold page-title mb-3 mb-md-0"><i class="bi bi-clipboard-check-fill me-2"></i>Laporan Absensi
                Pegawai</h3>
            <form method="GET" action="{{ url_for('absensi_pegawai_bp.absensi_pegawai') }}"
                  class="d-flex align-items-center gap-2 align-self-end align-self-md-auto">
                <input type="date" name="tanggal" class="form-control"
                       value="{{ tanggal_dipilih.strftime('%Y-%m-%d') }}">
                <button type="submit" class="btn btn-dark">Tampilkan</button>
            </form>
        </div>

        <div class="d-flex justify-content-end mb-3 gap-2">
            <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="bi bi-search me-2"></i>Cari & Filter
            </button>
            <a href="{{ url_for('export_bp.export_laporan', tipe='pegawai') }}" class="btn btn-success">
                <i class="bi bi-file-earmark-excel me-2"></i> Export Laporan
            </a>
        </div>

        {% if info_hari %}
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-x-fill me-2"></i>Informasi Hari Libur</h5>
                </div>
                <div class="card-body text-center p-5">
                    <h4 class="text-danger">{{ info_hari }}</h4>
                    <p class="text-muted">Tidak ada data absensi untuk ditampilkan pada tanggal ini.</p>
                </div>
            </div>
        {% else %}

            <!-- 1. FORMULIR AKSI MASSAL (Di luar Tabel) -->
            <!-- ACTION diarahakan ke endpoint update_status_masal yang sudah ada -->
            <form id="massalForm" action="{{ url_for('absensi_pegawai_bp.update_status_masal') }}" method="POST">

                <!-- Hidden inputs untuk menjaga tanggal saat submission -->
                <input type="hidden" name="tanggal_dipilih" value="{{ tanggal_dipilih.strftime('%Y-%m-%d') }}">

                <div class="card bg-light border-primary mb-3 shadow-sm">
                    <div class="card-body d-flex flex-wrap align-items-center gap-3">
                        <strong class="text-primary me-2"><i class="bi bi-person-gear me-1"></i> Aksi Cepat:</strong>

                        <!-- GANTI DROPDOWN DENGAN TOMBOL/BADGE Aksi Cepat CSS-ONLY -->
                        <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-success quick-fill-status clickable-badge" data-status="Hadir"
                          title="Centang semua, set status Hadir">
                        <i class="bi bi-person-check"></i> Hadir
                    </span>
                            <span class="badge bg-warning text-dark quick-fill-status clickable-badge"
                                  data-status="Terlambat" title="Centang semua, set status Terlambat">
                        <i class="bi bi-clock-fill"></i> Terlambat
                    </span>
                            <span class="badge bg-info quick-fill-status clickable-badge" data-status="Izin"
                                  title="Centang semua, set status Izin">
                        <i class="bi bi-file-earmark-person"></i> Izin
                    </span>
                            <span class="badge bg-danger quick-fill-status clickable-badge" data-status="Sakit"
                                  title="Centang semua, set status Sakit">
                        <i class="bi bi-bandaid"></i> Sakit
                    </span>
                            <span class="badge bg-secondary quick-fill-status clickable-badge" data-status="Alfa"
                                  title="Centang semua, set status Alfa">
                        <i class="bi bi-x-circle"></i> Alfa
                    </span>
                        </div>
                        <!-- AKHIR GANTI DROPDOWN -->

                        <div class="vr mx-2 d-none d-lg-block"></div> <!-- Pembatas visual -->

                        <!-- KELOMPOK AKSI TERAPKAN -->
                        <!-- Nama input diubah menjadi status_masal (sesuai update_status_masal) -->
                        <select name="status_masal" id="status_massal" class="form-select form-select-sm w-auto">
                            <option value="" disabled selected>Pilih Status Baru</option>
                            <option value="Hadir">Hadir</option>
                            <option value="Terlambat">Terlambat</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Izin">Izin</option>
                            <option value="Alfa">Alfa</option>
                        </select>

                        <!-- Tombol diubah ke type="button" agar JS bisa mengontrol submission -->
                        <button type="button" class="btn btn-primary btn-sm" id="btnTerapkanMassal">
                            <i class="bi bi-arrow-clockwise me-1"></i> Terapkan ke (<span id="countDisplay">0</span>)
                            Pegawai
                        </button>
                        <small class="text-primary ms-auto" id="counterMassal">0 pegawai terpilih</small>
                        <!-- AKHIR KELOMPOK AKSI TERAPKAN -->
                    </div>
                </div>


                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Daftar Absensi Pegawai</h5>
                        {% if cari_nama or role_filter or status %}
                            <a href="{{ url_for('absensi_pegawai_bp.absensi_pegawai', tanggal=tanggal_dipilih.strftime('%Y-%m-%d')) }}"
                               class="btn btn-danger btn-sm">
                                <i class="bi bi-x-circle me-2"></i>Reset Filter
                            </a>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle" id="absensiPegawaiTable">
                                <thead class="bg-dark text-white">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="checkAll" class="form-check-input">
                                    </th>
                                    <th>No</th>
                                    <th>No ID</th>
                                    <th>Nama Pegawai</th>
                                    <th>Role/Jabatan</th>
                                    <th>Status Masuk</th>
                                    <th>Status Pulang</th>
                                    <th>Aksi</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in data_absensi %}
                                    <!-- Tambahkan class 'pegawai-row' untuk JavaScript klik -->
                                    <tr class="pegawai-row">
                                        <td>
                                            <!-- name="no_id_list" agar sesuai dengan endpoint update_status_masal yang diharapkan -->
                                            <input type="checkbox" name="no_id_list" value="{{ item.pegawai.no_id }}"
                                                   class="form-check-input no-id-checkbox">
                                        </td>
                                        <td>{{ loop.index }}</td>
                                        <!-- Gunakan ID untuk memudahkan identifikasi di JS -->
                                        <td id="id-{{ item.pegawai.no_id }}"
                                            class="clickable-cell">{{ item.pegawai.no_id }}</td>
                                        <td id="nama-{{ item.pegawai.no_id }}"
                                            class="clickable-cell">{{ item.pegawai.nama }}</td>
                                        <td>{{ item.pegawai.role }}</td>
                                        <td>
                                            {% if item.masuk %}
                                                <span class="badge bg-{{ item.masuk.status | get_badge_color }}">{{ item.masuk.status }}</span>
                                                {% if item.masuk.waktu %}
                                                    <br>
                                                    <small class="text-muted">{{ item.masuk.waktu.strftime('%H:%M') }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-danger">Alfa</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.pulang %}
                                                <span class="badge bg-{{ item.pulang.status | get_badge_color }}">{{ item.pulang.status }}</span>
                                                {% if item.pulang.waktu %}
                                                    <br>
                                                    <small class="text-muted">{{ item.pulang.waktu.strftime('%H:%M') }}</small>
                                                {% endif %}
                                            {% elif item.masuk and item.masuk.jenis_absen in ['masuk', 'lainnya'] and item.masuk.status in ['Hadir', 'Terlambat'] %}
                                                <span class="badge bg-warning text-dark">Belum Pulang</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Kosong</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form action="{{ url_for('absensi_pegawai_bp.update_absensi_pegawai', no_id=item.pegawai.no_id) }}"
                                                  method="POST">
                                                <select name="status" class="form-select form-select-sm mb-1" required>
                                                    <option value="" disabled selected>Ubah Status</option>
                                                    <option value="Hadir">Hadir</option>
                                                    <option value="Sakit">Sakit</option>
                                                    <option value="Izin">Izin</option>
                                                    <option value="Alfa">Alfa</option>
                                                </select>
                                                <button type="submit" class="btn btn-sm btn-outline-secondary w-100">
                                                    Simpan
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-3">Tidak ada data pegawai
                                            ditemukan untuk filter ini.
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </form> <!-- Tutup Formulir Massal -->
        {% endif %}
    </div>

    <!-- Modal Filter (Tidak Berubah) -->
    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('absensi_pegawai_bp.absensi_pegawai') }}" method="get">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filterModalLabel">Cari & Filter Pegawai</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="cari_nama" class="form-label">Nama Pegawai</label>
                            <input type="text" class="form-control" id="cari_nama" name="cari_nama"
                                   value="{{ cari_nama if cari_nama }}">
                        </div>
                        <div class="mb-3">
                            <label for="filter_role" class="form-label">Filter Role/Jabatan</label>
                            <select class="form-select" id="filter_role" name="role_filter">
                                <option value="">-- Semua Role --</option>
                                <option value="guru" {% if role_filter == 'guru' %}selected{% endif %}>Guru</option>
                                <option value="staf" {% if role_filter == 'staf' %}selected{% endif %}>Staf</option>
                                <option value="keamanan" {% if role_filter == 'keamanan' %}selected{% endif %}>
                                    Keamanan
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="filter_status" class="form-label">Filter Status Kehadiran</label>
                            <select class="form-select" id="filter_status" name="status">
                                <option value="">-- Semua Status --</option>
                                <option value="Hadir" {% if status and status == 'Hadir' %}selected{% endif %}>Hadir
                                </option>
                                <option value="Terlambat" {% if status and status == 'Terlambat' %}selected{% endif %}>
                                    Terlambat
                                </option>
                                <option value="Sakit" {% if status and status == 'Sakit' %}selected{% endif %}>Sakit
                                </option>
                                <option value="Izin" {% if status and status == 'Izin' %}selected{% endif %}>Izin
                                </option>
                                <option value="Alfa" {% if status and status == 'Alfa' %}selected{% endif %}>Alfa
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('absensi_pegawai_bp.absensi_pegawai') }}" class="btn btn-danger me-auto">Reset
                            Filter</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-dark">Cari</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- START: Custom Message/Confirmation Box (Direplikasi dari Absensi Siswa) -->
    <div id="customMessageBox" class="modal fade" tabindex="-1" aria-labelledby="customMessageBoxLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white p-2">
                    <h5 class="modal-title fs-6" id="customMessageBoxLabel">Informasi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body text-center pt-4 pb-4">
                    <p id="customMessageText" class="mb-3"></p>
                    <div id="customMessageButtons">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Custom Message/Confirmation Box -->

    <style>
        /* Styling Badge Aksi Cepat Direplikasi dari Absensi Siswa */
        .clickable-cell {
            cursor: pointer;
        }

        .pegawai-row.selected {
            background-color: #e0f7fa !important;
        }

        .clickable-badge {
            cursor: pointer;
            transition: transform 0.1s;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            user-select: none;
        }

        .clickable-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .clickable-badge i {
            margin-right: 0.3rem;
        }
    </style>

    <!-- Tambahkan Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fix: Mengatasi ReferenceError: bootstrap is not defined
            // Memastikan objek bootstrap tersedia
            if (typeof bootstrap === 'undefined' || !bootstrap.Alert || !bootstrap.Modal) {
                console.error("Bootstrap JS/Modal is not fully loaded. Quick Actions may fail.");
                // Lanjutkan eksekusi meskipun error, tapi fungsionalitas modal/alert akan non-aktif.
            }

            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Alert) {
                        const bootstrapAlert = bootstrap.Alert.getOrCreateInstance(alert);
                        bootstrapAlert.close();
                    }
                }, 7000);
            });

            // =======================================================
            // CUSTOM MESSAGE BOX LOGIC (Replikasi dari Absensi Siswa)
            // =======================================================
            let messageBox, messageText, messageButtons;
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const messageBoxElement = document.getElementById('customMessageBox');
                messageBox = new bootstrap.Modal(messageBoxElement);
                messageText = document.getElementById('customMessageText');
                messageButtons = document.getElementById('customMessageButtons');
            }

            function showCustomDialog(message, type, callback = null) {
                if (!messageBox) {
                    // Fallback jika Bootstrap Modal gagal dimuat (walaupun seharusnya tidak terjadi)
                    if (type === 'confirm') {
                        if (window.confirm(message + " (Sistem Konfirmasi Darurat)")) {
                            if (callback) callback();
                        }
                    } else {
                        console.log("Peringatan: " + message);
                    }
                    return;
                }

                messageText.innerHTML = message;
                messageButtons.innerHTML = '';

                const modalTitle = document.getElementById('customMessageBoxLabel');
                modalTitle.textContent = type === 'confirm' ? 'Konfirmasi Aksi Massal' : 'Peringatan';

                if (type === 'alert') {
                    const okButton = document.createElement('button');
                    okButton.className = 'btn btn-primary w-100';
                    okButton.textContent = 'OK';
                    okButton.setAttribute('data-bs-dismiss', 'modal');
                    messageButtons.appendChild(okButton);
                } else if (type === 'confirm') {
                    const cancelButton = document.createElement('button');
                    cancelButton.className = 'btn btn-secondary me-2';
                    cancelButton.textContent = 'Batal';
                    cancelButton.setAttribute('data-bs-dismiss', 'modal');
                    messageButtons.appendChild(cancelButton);

                    const confirmButton = document.createElement('button');
                    confirmButton.className = 'btn btn-danger';
                    confirmButton.textContent = 'Ya, Terapkan';

                    confirmButton.addEventListener('click', function () {
                        messageBox.hide();
                        if (callback) {
                            callback();
                        }
                    });
                    messageButtons.appendChild(confirmButton);
                }

                messageBox.show();
            }

            // =======================================================
            // LOGIKA CHECKBOX MASSAL (Diadaptasi dari Siswa)
            // Element names diubah dari 'nis' ke 'no-id'
            // =======================================================
            const checkAll = document.getElementById('checkAll');
            // Checkboxes menggunakan class 'no-id-checkbox' dan name 'no_id_list'
            const checkboxes = document.querySelectorAll('.no-id-checkbox');
            const counterMassal = document.getElementById('counterMassal');
            const countDisplay = document.getElementById('countDisplay');
            // Row menggunakan class 'pegawai-row'
            const tableRows = document.querySelectorAll('.pegawai-row');
            const btnTerapkanMassal = document.getElementById('btnTerapkanMassal');
            const massalForm = document.getElementById('massalForm');
            const statusMassalSelect = document.getElementById('status_massal');

            // Target baru: span.quick-fill-status
            const quickFillItems = document.querySelectorAll('.quick-fill-status');

            // Fungsi untuk memperbarui hitungan dan tampilan
            function updateCounter() {
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                counterMassal.textContent = `${checkedCount} pegawai terpilih`;
                countDisplay.textContent = checkedCount;

                // Atur status CheckAll
                const total = checkboxes.length;
                checkAll.checked = checkedCount > 0 && checkedCount === total;
                checkAll.indeterminate = checkedCount > 0 && checkedCount < total;

                // Perbarui visualisasi baris
                checkboxes.forEach(cb => {
                    const row = cb.closest('.pegawai-row');
                    if (row) {
                        if (cb.checked) {
                            row.classList.add('selected');
                        } else {
                            row.classList.remove('selected');
                        }
                    }
                });

                // Aktifkan/Nonaktifkan Tombol Terapkan berdasarkan count & select value
                const isStatusSelected = statusMassalSelect.value !== "";
                btnTerapkanMassal.disabled = checkedCount === 0 || !isStatusSelected;
            }

            // Event listener untuk "Pilih Semua"
            checkAll.addEventListener('change', function () {
                checkboxes.forEach(cb => {
                    cb.checked = checkAll.checked;
                });
                updateCounter();
            });

            // Event listener untuk checkbox individual
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateCounter);
            });

            // Event listener untuk Dropdown Status Massal
            statusMassalSelect.addEventListener('change', updateCounter);

            // KLIK DI SEL NO ID/NAMA JUGA MENCENTANG PEGAWAI
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('.clickable-cell');
                const checkbox = row.querySelector('.no-id-checkbox');

                const handleCellClick = (event) => {
                    // Pastikan klik BUKAN berasal dari elemen interaktif (checkbox, select, button)
                    if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'BUTTON' && event.target.tagName !== 'SELECT') {
                        // Toggle status checkbox
                        checkbox.checked = !checkbox.checked;
                        updateCounter(); // Perbarui hitungan setelah toggle
                    }
                };

                cells.forEach(cell => {
                    cell.addEventListener('click', handleCellClick);
                });
            });

            // =======================================================
            // LOGIKA QUICK FILL (ISI CEPAT SEMUA STATUS) - MENGGUNAKAN SPAN/BADGE
            // =======================================================
            quickFillItems.forEach(item => {
                item.addEventListener('click', function (event) {
                    event.preventDefault();

                    const selectedStatus = this.getAttribute('data-status');

                    // 1. Centang semua pegawai
                    checkboxes.forEach(cb => {
                        cb.checked = true;
                    });

                    // 2. Set dropdown status massal ke status yang dipilih
                    statusMassalSelect.value = selectedStatus;

                    // 3. Perbarui tampilan counter dan tombol
                    updateCounter();

                    const message = `Semua pegawai sudah dicentang dan status <b>"${selectedStatus}"</b> sudah terpilih.<br><br>Sekarang, Anda hanya perlu HILANGKAN centang pada pegawai yang statusnya BERBEDA, lalu klik tombol <b>TERAPKAN</b>.`;
                    showCustomDialog(message, 'alert');
                });
            });


            // =======================================================
            // MANUAL SUBMIT DENGAN KLIK TOMBOL MASSAL (Menggunakan Custom Confirm)
            // =======================================================
            btnTerapkanMassal.addEventListener('click', function (event) {
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                const status = statusMassalSelect.value;

                if (checkedCount === 0) {
                    showCustomDialog('Silakan pilih minimal satu pegawai yang akan diubah statusnya.', 'alert');
                    return;
                }
                if (status === "") {
                    showCustomDialog('Silakan pilih STATUS BARU (Hadir, Sakit, Izin, Alfa, atau Terlambat) dari daftar dropdown di samping.', 'alert');
                    return;
                }

                const confirmMessage = `Anda yakin ingin mengubah status <b>${checkedCount} pegawai</b> menjadi <b>${status}</b>? Aksi ini akan menimpa catatan absensi (masuk/pulang) mereka hari ini.`;

                showCustomDialog(confirmMessage, 'confirm', function () {
                    massalForm.submit();
                });
            });

            // Panggil saat DOM dimuat untuk inisialisasi counter
            updateCounter();
        });

    </script>
{% endblock %}
