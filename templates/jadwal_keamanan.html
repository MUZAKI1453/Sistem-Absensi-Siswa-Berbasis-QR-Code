{% extends "base.html" %}
{% block title %}Jadwal Keamanan{% endblock %}

{% block content %}

    <div class="container-fluid">
        <h3 class="fw-bold mb-4 page-title"><i class="bi bi-calendar2-week me-2"></i>Jadwal Keamanan Bulanan</h3>
        
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
            <form method="GET" action="{{ url_for('jadwal_keamanan_bp.jadwal_keamanan') }}"
                  class="d-flex align-items-center">
                <input type="hidden" name="year" value="{{ current_year }}">
                <button class="btn btn-outline-primary me-2" name="month"
                        value="{{ current_month - 1 if current_month > 1 else 12 }}">
                    <i class="bi bi-arrow-left-circle"></i>
                </button>

                <h5 class="m-0 text-center">
                    {{ current_date.strftime('%B %Y') }}
                </h5>

                <button class="btn btn-outline-primary ms-2" name="month"
                        value="{{ current_month + 1 if current_month < 12 else 1 }}">
                    <i class="bi bi-arrow-right-circle"></i>
                </button>
            </form>

            <div class="d-flex gap-2">
                <form method="POST" action="{{ url_for('jadwal_keamanan_bp.copy_previous_schedule') }}"
                      class="d-inline">
                    <input type="hidden" name="current_month" value="{{ current_month }}">
                    <input type="hidden" name="current_year" value="{{ current_year }}">
                    <button class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-copy me-1"></i> Salin dari Bulan Sebelumnya
                    </button>
                </form>
                
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#importJadwalModal">
                    <i class="bi bi-file-earmark-arrow-up me-1"></i> Impor Jadwal (CSV)
                </button>
            </div>
        </div>

        <form method="POST" action="{{ url_for('jadwal_keamanan_bp.simpan_jadwal_keamanan') }}">
            <input type="hidden" name="month" value="{{ current_month }}">
            <input type="hidden" name="year" value="{{ current_year }}">

            <div class="table-responsive shadow-sm rounded-3">
                <table class="table table-bordered align-middle text-center table-striped small">
                    <thead class="table-primary">
                    <tr>
                        <th>Nama Petugas</th>
                        {% for day in range(1, days_in_month + 1) %}
                            <th>{{ day }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for staff in security_staff %}
                        <tr>
                            <td class="text-start fw-semibold">{{ staff.nama }}</td>
                            {% for day in range(1, days_in_month + 1) %}
                                {% set date_str = date(current_year, current_month, day).strftime('%Y-%m-%d') %}
                                {% set shift_value = staff_schedules.get(staff.id, {}).get(date_str, '') %}
                                <td>
                                    <select name="schedule_{{ staff.id }}_{{ date_str }}"
                                            class="form-select form-select-sm">
                                        <option value="" {% if shift_value == '' %}selected{% endif %}>-</option>
                                        <option value="shift1" {% if shift_value == 'shift1' %}selected{% endif %}>Shift
                                            1
                                        </option>
                                        <option value="shift2" {% if shift_value == 'shift2' %}selected{% endif %}>Shift
                                            2
                                        </option>
                                        <option value="shift3" {% if shift_value == 'shift3' %}selected{% endif %}>Shift
                                            3
                                        </option>
                                        <option value="shift4" {% if shift_value == 'shift4' %}selected{% endif %}>Shift
                                            4
                                        </option>
                                        <option value="Off" {% if shift_value == 'Off' %}selected{% endif %}>Off
                                        </option>
                                    </select>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-3">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save me-1"></i> Simpan Jadwal
                </button>
            </div>
        </form>
    </div>

    <div class="modal fade" id="importJadwalModal" tabindex="-1" aria-labelledby="importJadwalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importJadwalModalLabel"><i class="bi bi-file-earmark-arrow-up me-2"></i>Impor Jadwal Keamanan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('jadwal_keamanan_bp.impor_jadwal_keamanan') }}" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        
                        <div class="alert alert-info" role="alert">
                            <h6 class="alert-heading fw-bold">Petunjuk Format CSV</h6>
                            <p class="small">Pastikan file CSV Anda memiliki kolom-kolom berikut (sesuai urutan):</p>
                            <pre class="small bg-white p-2 rounded"><code>No_id,nama,shift_tgl1,shift_tgl2,...,shift_tgl31</code></pre>
                            <hr>
                            <ul class="small mb-0">
                                <li>Kolom `No_id` harus sesuai dengan database.</li>
                                <li>Kolom `nama` hanya untuk referensi Anda.</li>
                                <li>Pilih Bulan dan Tahun di bawah ini.</li>
                            </ul>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="import_bulan" class="form-label fw-bold">Bulan Impor</label>
                                <select class="form-select" id="import_bulan" name="import_bulan" required>
                                    </select>
                            </div>
                            <div class="col-md-6">
                                <label for="import_tahun" class="form-label fw-bold">Tahun Impor</label>
                                <input type="number" class="form-control" id="import_tahun" name="import_tahun" 
                                       value="{{ current_year }}" placeholder="Contoh: 2025" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="csv_file" class="form-label fw-bold">Pilih File CSV</label>
                            <input class="form-control" type="file" id="csv_file" name="csv_file" accept=".csv" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-upload me-1"></i> Upload dan Impor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <style>
        /* CSS tidak berubah */
        h4 {
            font-weight: 600;
        }
        table {
            font-size: 0.85rem;
        }
        select.form-select-sm {
            min-width: 70px;
            padding: 0.2rem 0.4rem;
        }
        .table th, .table td {
            vertical-align: middle;
            text-align: center;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const monthSelect = document.getElementById('import_bulan');
            if (monthSelect) {
                const months = [
                    "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
                    "Juli", "Agustus", "September", "Oktober", "November", "Desember"
                ];
                
                const currentMonthOnPage = parseInt("{{ current_month }}"); 
                
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = month;
                    // Pilih bulan yang sama dengan yang ditampilkan di halaman
                    if ((index + 1) === currentMonthOnPage) {
                        option.selected = true;
                    }
                    monthSelect.appendChild(option);
                });
            }
        });
    </script>

{% endblock %}