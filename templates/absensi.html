{% extends "base.html" %}
{% block title %}Absensi Siswa{% endblock %}

{% block content %}
<!-- START: MEMASTIKAN BOOTSTRAP CSS DIMUAT UNTUK STYLING -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- END: MEMASTIKAN BOOTSTRAP CSS DIMUAT UNTUK STYLING -->

<div class="container mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center mb-4">
        <h3 class="fw-bold page-title mb-3 mb-md-0"><i class="bi bi-clipboard-check me-2"></i>Laporan Absensi Siswa</h3>
        <form method="GET" action="{{ url_for('absensi_bp.absensi') }}" class="d-flex align-items-center gap-2 align-self-end align-self-md-auto">
            <input type="date" name="tanggal" class="form-control" value="{{ tanggal_dipilih.strftime('%Y-%m-%d') }}">
            <button type="submit" class="btn btn-dark">Tampilkan</button>
        </form>
    </div>

    <div class="d-flex justify-content-end mb-3 gap-2">
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="bi bi-search me-2"></i>Cari & Filter
        </button>
        <a href="{{ url_for('export_bp.export_laporan') }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel me-2"></i>Export Laporan
        </a>
    </div>

    {% if info_hari %}
    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-x-fill me-2"></i>Informasi Hari Libur</h5>
        </div>
        <div class="card-body text-center p-5">
            <h4 class="text-danger">{{ info_hari }}</h4>
            <p class="text-muted">Tidak ada data absensi untuk ditampilkan pada tanggal ini.</p>
        </div>
    </div>
    {% else %}

    <!-- 1. FORMULIR AKSI MASSAL (Di luar Tabel) - Tombol diubah menjadi type="button" -->
    <form id="massalForm" action="{{ url_for('absensi_bp.update_absensi_massal') }}" method="POST">

        <!-- Hidden inputs untuk menjaga filter saat redirect -->
        <input type="hidden" name="kelas_id" value="{{ kelas_id or '' }}">
        <input type="hidden" name="cari_nama" value="{{ cari_nama or '' }}">
        <input type="hidden" name="tanggal_dipilih" value="{{ tanggal_dipilih.strftime('%Y-%m-%d') }}">

        <div class="card bg-light border-primary mb-3 shadow-sm">
            <div class="card-body d-flex flex-wrap align-items-center gap-3">
                <strong class="text-primary me-2"><i class="bi bi-person-check me-1"></i> Aksi Cepat:</strong>

                <!-- GANTI DROPDOWN DENGAN TOMBOL/BADGE Aksi Cepat CSS-ONLY -->
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-success quick-fill-status clickable-badge" data-status="Hadir" title="Centang semua, set status Hadir">
                        <i class="bi bi-person-check"></i> Hadir
                    </span>
                    <span class="badge bg-warning text-dark quick-fill-status clickable-badge" data-status="Terlambat" title="Centang semua, set status Terlambat">
                        <i class="bi bi-clock-fill"></i> Terlambat
                    </span>
                    <span class="badge bg-info quick-fill-status clickable-badge" data-status="Izin" title="Centang semua, set status Izin">
                        <i class="bi bi-file-earmark-person"></i> Izin
                    </span>
                    <span class="badge bg-danger quick-fill-status clickable-badge" data-status="Sakit" title="Centang semua, set status Sakit">
                        <i class="bi bi-bandaid"></i> Sakit
                    </span>
                    <span class="badge bg-secondary quick-fill-status clickable-badge" data-status="Alfa" title="Centang semua, set status Alfa">
                        <i class="bi bi-x-circle"></i> Alfa
                    </span>
                </div>
                <!-- AKHIR GANTI DROPDOWN -->

                <div class="vr mx-2 d-none d-lg-block"></div> <!-- Pembatas visual -->

                <!-- KELOMPOK AKSI TERAPKAN -->
                <select name="status_massal" id="status_massal" class="form-select form-select-sm w-auto">
                    <option value="" disabled selected>Pilih Status Baru</option>
                    <option value="Hadir">Hadir</option>
                    <option value="Terlambat">Terlambat</option>
                    <option value="Sakit">Sakit</option>
                    <option value="Izin">Izin</option>
                    <option value="Alfa">Alfa</option>
                </select>

                <!-- Tombol diubah ke type="button" agar JS bisa mengontrol submission -->
                <button type="button" class="btn btn-primary btn-sm" id="btnTerapkanMassal">
                    <i class="bi bi-arrow-clockwise me-1"></i> Terapkan ke (<span id="countDisplay">0</span>) Siswa
                </button>
                <small class="text-primary ms-auto" id="counterMassal">0 siswa terpilih</small>
                <!-- AKHIR KELOMPOK AKSI TERAPKAN -->
            </div>
        </div>


    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Daftar Absensi Siswa</h5>
            {% if cari_nama or kelas_id or status %}
            <a href="{{ url_for('absensi_bp.absensi', tanggal=tanggal_dipilih.strftime('%Y-%m-%d')) }}" class="btn btn-danger btn-sm">
                <i class="bi bi-x-circle me-2"></i>Reset Filter
            </a>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" id="absensiTable">
                    <thead class="bg-dark text-white">
                        <tr>
                            <!-- KOLOM BARU UNTUK CHECKBOX MASSAL -->
                            <th>
                                <input type="checkbox" id="checkAll" class="form-check-input">
                            </th>
                            <th>No</th>
                            <th>NIS</th>
                            <th>Nama Siswa</th>
                            <th>Kelas</th>
                            <th>Status Masuk</th>
                            <th>Status Pulang</th>
                            <th>Aksi Individual</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in data_absensi %}
                        <!-- Tambahkan class 'siswa-row' untuk JavaScript klik -->
                        <tr class="siswa-row">
                            <!-- CHECKBOX SISWA -->
                            <td>
                                <input type="checkbox" name="nis_selected" value="{{ item.siswa.nis }}" class="form-check-input nis-checkbox">
                            </td>
                            <td>{{ loop.index }}</td>
                            <!-- Gunakan ID untuk memudahkan identifikasi di JS -->
                            <td id="nis-{{ item.siswa.nis }}" class="clickable-cell">{{ item.siswa.nis }}</td>
                            <td id="nama-{{ item.siswa.nis }}" class="clickable-cell">{{ item.siswa.nama }}</td>
                            <td>{{ item.siswa.kelas_relasi.nama if item.siswa.kelas_relasi else 'Tidak Diketahui' }}</td>
                            <td>
                                {% if item.masuk %}
                                    <span class="badge bg-{{ item.masuk.status | get_badge_color }}">{{ item.masuk.status }}</span>
                                    {% if item.masuk.waktu %}
                                        <br><small class="text-muted">{{ item.masuk.waktu.strftime('%H:%M') }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-danger">Alfa</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.pulang %}
                                    <span class="badge bg-{{ item.pulang.status | get_badge_color }}">{{ item.pulang.status }}</span>
                                    {% if item.pulang.waktu %}
                                        <br><small class="text-muted">{{ item.pulang.waktu.strftime('%H:%M') }}</small>
                                    {% endif %}
                                {% elif item.masuk and item.masuk.jenis_absen in ['masuk', 'lainnya'] %}
                                    <span class="badge bg-warning text-dark">Belum Pulang</span>
                                {% else %}
                                    <span class="badge bg-secondary">Kosong</span>
                                {% endif %}
                            </td>
                            <td>
                                <form action="{{ url_for('absensi_bp.update_absensi', nis=item.siswa.nis) }}" method="POST">
                                    <!-- Hidden inputs untuk menjaga filter saat redirect -->
                                    <input type="hidden" name="kelas_id" value="{{ kelas_id or '' }}">
                                    <input type="hidden" name="cari_nama" value="{{ cari_nama or '' }}">
                                    <input type="hidden" name="tanggal_dipilih" value="{{ tanggal_dipilih.strftime('%Y-%m-%d') }}">

                                    <select name="status" class="form-select form-select-sm mb-1" required>
                                        <option value="" disabled selected>Ubah Status</option>
                                        <option value="Hadir">Hadir</option>
                                        <option value="Terlambat">Terlambat</option>
                                        <option value="Sakit">Sakit</option>
                                        <option value="Izin">Izin</option>
                                        <option value="Alfa">Alfa</option>
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-outline-secondary w-100">Simpan</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-3">Tidak ada data siswa ditemukan untuk filter ini.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    </form> <!-- Tutup Formulir Massal -->
    {% endif %}
</div>

<!-- Modal Filter (Tidak Berubah) -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('absensi_bp.absensi') }}" method="get">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Cari & Filter Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cari_nama" class="form-label">Nama Siswa</label>
                        <input type="text" class="form-control" id="cari_nama" name="cari_nama" value="{{ cari_nama or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="filter_kelas" class="form-label">Filter Kelas</label>
                        <select class="form-select" id="filter_kelas" name="kelas_id">
                            <option value="">-- Semua Kelas --</option>
                            {% for k in kelas_list %}
                                <option value="{{ k.id }}" {% if kelas_id and kelas_id|string == k.id|string %}selected{% endif %}>
                                    {{ k.nama }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filter_status" class="form-label">Filter Status</label>
                        <select class="form-select" id="filter_status" name="status">
                            <option value="">-- Semua Status --</option>
                            <option value="Hadir" {% if status == 'Hadir' %}selected{% endif %}>Hadir</option>
                            <option value="Terlambat" {% if status == 'Terlambat' %}selected{% endif %}>Terlambat</option>
                            <option value="Sakit" {% if status == 'Sakit' %}selected{% endif %}>Sakit</option>
                            <option value="Izin" {% if status == 'Izin' %}selected{% endif %}>Izin</option>
                            <option value="Alfa" {% if status == 'Alfa' %}selected{% endif %}>Alfa</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('absensi_bp.absensi', tanggal=tanggal_dipilih.strftime('%Y-%m-%d')) }}" class="btn btn-danger me-auto">Reset Filter</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-dark">Cari</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- START: Custom Message/Confirmation Box (MUST replace alert/confirm) -->
<div id="customMessageBox" class="modal fade" tabindex="-1" aria-labelledby="customMessageBoxLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white p-2">
                <h5 class="modal-title fs-6" id="customMessageBoxLabel">Informasi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center pt-4 pb-4">
                <p id="customMessageText" class="mb-3"></p>
                <div id="customMessageButtons">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END: Custom Message/Confirmation Box -->

<style>
    /* Tambahkan style untuk menandakan sel yang dapat di-klik */
    .clickable-cell {
        cursor: pointer;
    }
    /* Tambahkan style untuk baris yang terpilih */
    .siswa-row.selected {
        background-color: #e0f7fa !important; /* Warna biru muda, penting agar menimpa striped */
    }
    /* Style untuk Badge Aksi Cepat yang baru (memastikan ia terlihat seperti tombol) */
    .clickable-badge {
        cursor: pointer;
        transition: transform 0.1s;
        padding: 0.5rem 0.75rem; /* Tambahkan padding */
        border-radius: 0.375rem; /* Tambahkan border-radius */
        font-weight: 600;
        user-select: none; /* Mencegah pemilihan teks */
    }
    .clickable-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .clickable-badge i {
        margin-right: 0.3rem;
    }
</style>

<!-- Tambahkan Bootstrap JS CDN di sini (tetap diperlukan untuk Modal/Alerts kustom) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fix: 'bootstrap' object is now available here

        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                // Pastikan elemen alert memiliki instance Bootstrap Alert sebelum memanggil .close()
                const bootstrapAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bootstrapAlert.close();
            }, 7000);
        });

        // =======================================================
        // CUSTOM MESSAGE BOX LOGIC (Replaces alert/confirm)
        // =======================================================
        const messageBoxElement = document.getElementById('customMessageBox');
        const messageBox = new bootstrap.Modal(messageBoxElement); // Correctly initializes Bootstrap Modal
        const messageText = document.getElementById('customMessageText');
        const messageButtons = document.getElementById('customMessageButtons');

        /**
         * Shows a custom alert or confirmation dialog.
         * @param {string} message - The message to display.
         * @param {string} type - 'alert' or 'confirm'.
         * @param {function} [callback] - Function to run on confirmation (for 'confirm').
         */
        function showCustomDialog(message, type, callback = null) {
            messageText.innerHTML = message;
            messageButtons.innerHTML = '';

            // Ensure the modal title is updated correctly
            const modalTitle = document.getElementById('customMessageBoxLabel');
            modalTitle.textContent = type === 'confirm' ? 'Konfirmasi Aksi Massal' : 'Peringatan';

            if (type === 'alert') {
                const okButton = document.createElement('button');
                okButton.className = 'btn btn-primary w-100';
                okButton.textContent = 'OK';
                okButton.setAttribute('data-bs-dismiss', 'modal');
                messageButtons.appendChild(okButton);
            } else if (type === 'confirm') {
                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn btn-secondary me-2';
                cancelButton.textContent = 'Batal';
                cancelButton.setAttribute('data-bs-dismiss', 'modal');
                messageButtons.appendChild(cancelButton);

                const confirmButton = document.createElement('button');
                confirmButton.className = 'btn btn-danger';
                confirmButton.textContent = 'Ya, Terapkan';

                confirmButton.addEventListener('click', function() {
                    messageBox.hide();
                    if (callback) {
                        callback();
                    }
                });
                messageButtons.appendChild(confirmButton);
            }

            messageBox.show();
        }


        // =======================================================
        // LOGIKA CHECKBOX MASSAL
        // =======================================================
        const checkAll = document.getElementById('checkAll');
        const checkboxes = document.querySelectorAll('.nis-checkbox');
        const counterMassal = document.getElementById('counterMassal');
        const countDisplay = document.getElementById('countDisplay');
        const tableRows = document.querySelectorAll('.siswa-row');
        const btnTerapkanMassal = document.getElementById('btnTerapkanMassal');
        const massalForm = document.getElementById('massalForm');
        const statusMassalSelect = document.getElementById('status_massal');

        // Target baru: span.quick-fill-status
        const quickFillItems = document.querySelectorAll('.quick-fill-status');

        // Fungsi untuk memperbarui hitungan dan tampilan
        function updateCounter() {
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            counterMassal.textContent = `${checkedCount} siswa terpilih`;
            countDisplay.textContent = checkedCount;

            // Atur status CheckAll
            const total = checkboxes.length;
            checkAll.checked = checkedCount > 0 && checkedCount === total;
            checkAll.indeterminate = checkedCount > 0 && checkedCount < total;

            // Perbarui visualisasi baris
            checkboxes.forEach(cb => {
                const row = cb.closest('.siswa-row');
                if (row) {
                    if (cb.checked) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                }
            });
        }

        // Event listener untuk "Pilih Semua"
        checkAll.addEventListener('change', function() {
            checkboxes.forEach(cb => {
                cb.checked = checkAll.checked;
            });
            updateCounter();
        });

        // Event listener untuk checkbox individual
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCounter);
        });

        // KLIK DI SEL NIS/NAMA JUGA MENCENTANG SISWA
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('.clickable-cell');
            const checkbox = row.querySelector('.nis-checkbox');

            const handleCellClick = (event) => {
                // Pastikan klik BUKAN berasal dari elemen interaktif (checkbox, select, button)
                if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'BUTTON' && event.target.tagName !== 'SELECT') {
                    // Toggle status checkbox
                    checkbox.checked = !checkbox.checked;
                    updateCounter(); // Perbarui hitungan setelah toggle
                }
            };

            cells.forEach(cell => {
                cell.addEventListener('click', handleCellClick);
            });
        });

        // =======================================================
        // BARU: LOGIKA QUICK FILL (ISI CEPAT SEMUA STATUS) - MENGGUNAKAN SPAN/BADGE
        // =======================================================
        quickFillItems.forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault(); // Mencegah tindakan default

                const selectedStatus = this.getAttribute('data-status');

                // 1. Centang semua siswa
                checkboxes.forEach(cb => {
                    cb.checked = true;
                });

                // 2. Set dropdown status massal ke status yang dipilih
                statusMassalSelect.value = selectedStatus;

                // 3. Perbarui tampilan counter
                updateCounter();

                const message = `Semua siswa sudah dicentang dan status <b>"${selectedStatus}"</b> sudah terpilih.<br><br>Sekarang, Anda hanya perlu HILANGKAN centang pada siswa yang statusnya BERBEDA, lalu klik tombol <b>TERAPKAN</b>.`;
                showCustomDialog(message, 'alert');
            });
        });


        // =======================================================
        // MANUAL SUBMIT DENGAN KLIK TOMBOL MASSAL (Menggunakan Custom Confirm)
        // =======================================================
        btnTerapkanMassal.addEventListener('click', function(event) {
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const status = statusMassalSelect.value;

            if (checkedCount === 0) {
                showCustomDialog('Silakan pilih minimal satu siswa yang akan diubah statusnya.', 'alert');
                return;
            }
            if (status === "") {
                showCustomDialog('Silakan pilih STATUS BARU (Hadir, Sakit, Izin, Alfa, atau Terlambat) dari daftar dropdown di samping.', 'alert');
                return;
            }

            const confirmMessage = `Anda yakin ingin mengubah status <b>${checkedCount} siswa</b> menjadi <b>${status}</b>? Aksi ini akan menimpa catatan absensi (masuk/pulang) mereka hari ini.`;

            showCustomDialog(confirmMessage, 'confirm', function() {
                massalForm.submit();
            });
        });

        // Panggil saat DOM dimuat untuk inisialisasi counter
        updateCounter();
    });

</script>
{% endblock %}