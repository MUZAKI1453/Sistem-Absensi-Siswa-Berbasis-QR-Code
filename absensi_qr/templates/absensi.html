{% extends "base.html" %}
{% block content %}

<div class="container my-4">
<h3 class="mb-4">Laporan Absensi Harian</h3>

<!-- Formulir Filter dan Pencarian -->
<form method="GET" class="row g-3 mb-4 align-items-end">
    <div class="col-md-3">
        <label for="kelas" class="form-label">Filter Kelas</label>
        <select id="kelas" name="kelas" class="form-select">
            <option value="">-- Semua Kelas --</option>
            {% for k in kelas_list %}
            <option value="{{ k }}" {% if kelas == k %}selected{% endif %}>{{ k }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <label for="searchInput" class="form-label">Cari Nama Siswa</label>
        <input type="text" id="searchInput" class="form-control" placeholder="Cari nama...">
    </div>
    <div class="col-md-6 d-flex justify-content-end gap-2">
        <button type="submit" class="btn btn-primary">Tampilkan</button>
        <a href="{{ url_for('export_laporan') }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export Bulanan
        </a>
    </div>
</form>

<!-- Tabel Laporan Absensi -->
<div class="table-responsive shadow-sm rounded">
    <table class="table table-bordered table-striped table-hover align-middle" id="absensiTable">
        <thead class="table-dark">
            <tr>
                <th>No</th>
                <th>NIS</th>
                <th>Nama Siswa</th>
                <th>Kelas</th>
                <th>Status Masuk</th>
                <th>Status Pulang</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for nis, data in data_absensi.items() %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ data.siswa.nis }}</td>
                <td>{{ data.siswa.nama }}</td>
                <td>{{ data.siswa.kelas }}</td>
                <td>
                    <!-- Perubahan Logika Status Masuk -->
                    {% if data.masuk %}
                        <span class="badge bg-{{ data.masuk.status | get_badge_color }}">{{ data.masuk.status }}</span>
                        {% if data.masuk.waktu %}
                        <br><small class="text-muted">{{ data.masuk.waktu.strftime('%H:%M') }}</small>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">Kosong</span>
                    {% endif %}
                </td>
                <td>
                    <!-- Perubahan Logika Status Pulang -->
                    {% if data.pulang %}
                        <span class="badge bg-{{ data.pulang.status | get_badge_color }}">{{ data.pulang.status }}</span>
                        {% if data.pulang.waktu %}
                        <br><small class="text-muted">{{ data.pulang.waktu.strftime('%H:%M') }}</small>
                        {% endif %}
                    {% elif data.masuk and data.masuk.status == 'Hadir' %}
                        <span class="badge bg-warning text-dark">Belum Pulang</span>
                    {% else %}
                        <span class="badge bg-secondary">Kosong</span>
                    {% endif %}
                </td>
                <td>
                    <!-- Form aksi untuk ubah status manual -->
                    <form action="{{ url_for('update_absensi', nis=nis) }}" method="POST">
                        <input type="hidden" name="kelas" value="{{ kelas }}">
                        <select name="status" class="form-select form-select-sm mb-1" required>
                            <option value="" disabled selected>Ubah Status</option>
                            <option value="Hadir" {% if data.masuk and data.masuk.status == 'Hadir' %}selected{% endif %}>Hadir</option>
                            <option value="Izin" {% if data.masuk and data.masuk.status == 'Izin' %}selected{% endif %}>Izin</option>
                            <option value="Sakit" {% if data.masuk and data.masuk.status == 'Sakit' %}selected{% endif %}>Sakit</option>
                            <option value="Alfa" {% if data.masuk and data.masuk.status == 'Alfa' %}selected{% endif %}>Alfa</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-secondary w-100">Simpan</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center text-muted py-3">Tidak ada data siswa ditemukan.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// Fungsi untuk menyembunyikan notifikasi setelah 7 detik
const alerts = document.querySelectorAll('.alert');
alerts.forEach(alert => {
setTimeout(() => {
const bootstrapAlert = new bootstrap.Alert(alert);
bootstrapAlert.close();
}, 7000);
});

    // Fungsi pencarian
    document.getElementById(&quot;searchInput&quot;).addEventListener(&quot;keyup&quot;, function () {
        var value = this.value.toLowerCase();
        var table = document.getElementById(&quot;absensiTable&quot;);
        var rows = table.getElementsByTagName(&quot;tbody&quot;)[0].getElementsByTagName(&quot;tr&quot;);
        for (var i = 0; i &lt; rows.length; i++) {
            var row = rows[i];
            // Skip the &quot;no data&quot; row
            if (row.cells.length &lt;= 1) {
                continue;
            }
            // Cell index 2 is for the student name (Nama Siswa)
            var nama = row.cells[2].textContent.toLowerCase();
            row.style.display = nama.includes(value) ? &quot;&quot; : &quot;none&quot;;
        }
    });
});

</script>

{% endblock %}