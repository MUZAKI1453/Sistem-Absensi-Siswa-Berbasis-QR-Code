{% extends "base.html" %}

{% block title %}Kelola Siswa{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-end mb-3 gap-2">
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="bi bi-search me-2"></i>Cari & Filter
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#siswaModal">
            <i class="bi bi-plus-circle me-2"></i>Tambah Siswa
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Daftar Siswa</h5>
            {% if cari_nama or filter_kelas %}
                <a href="{{ url_for('siswa') }}" class="btn btn-danger btn-sm">
                    <i class="bi bi-x-circle me-2"></i>Reset Filter
                </a>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr class="bg-light">
                            <th>No</th>
                            <th>NIS</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>No. HP Orang Tua</th>
                            <th>QR Code</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for siswa_data in siswa %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ siswa_data.nis }}</td>
                            <td>{{ siswa_data.nama }}</td>
                            <td>{{ siswa_data.kelas }}</td>
                            <td>{{ siswa_data.no_hp_ortu }}</td>
                            <td>
                                <img src="{{ url_for('view_qr', nis=siswa_data.nis) }}" alt="QR Code" style="width: 50px; height: auto;">
                            </td>
                            <td class="text-nowrap">
                                <button type="button" class="btn btn-warning btn-sm me-1 btn-edit-siswa"
                                    data-bs-toggle="modal"
                                    data-bs-target="#siswaModal"
                                    data-id="{{ siswa_data.id }}"
                                    data-nis="{{ siswa_data.nis }}"
                                    data-nama="{{ siswa_data.nama }}"
                                    data-kelas="{{ siswa_data.kelas }}"
                                    data-nohp="{{ siswa_data.no_hp_ortu }}">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <a href="{{ url_for('hapus_siswa', id=siswa_data.id) }}" class="btn btn-danger btn-sm me-1" onclick="return confirm('Apakah Anda yakin ingin menghapus data siswa ini?')"><i class="bi bi-trash"></i> Hapus</a>
                                <a href="{{ url_for('download_qr', nis=siswa_data.nis) }}" class="btn btn-info btn-sm text-white"><i class="bi bi-download"></i> Download QR</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="siswaModal" tabindex="-1" aria-labelledby="siswaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="siswaForm" action="{{ url_for('siswa') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="siswaModalLabel">Tambah Data Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id" name="edit_id">
                    <div class="mb-3">
                        <label for="nis" class="form-label">NIS</label>
                        <input type="text" class="form-control" id="nis-input" name="nis" required>
                    </div>
                    <div class="mb-3">
                        <label for="nama" class="form-label">Nama</label>
                        <input type="text" class="form-control" id="nama-input" name="nama" required>
                    </div>
                    <div class="mb-3">
                        <label for="kelas" class="form-label">Kelas</label>
                        <input type="text" class="form-control" id="kelas-input" name="kelas" required>
                    </div>
                    <div class="mb-3">
                        <label for="no_hp" class="form-label">No. HP Orang Tua</label>
                        <input type="tel" class="form-control" id="no-hp-input" name="no_hp" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Tambahkan Siswa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('siswa') }}" method="get">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Cari & Filter Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cari_nama" class="form-label">Nama Siswa</label>
                        <input type="text" class="form-control" id="cari_nama" name="cari_nama" value="{{ cari_nama if cari_nama }}">
                    </div>
                    <div class="mb-3">
                        <label for="filter_kelas" class="form-label">Filter Kelas</label>
                        <select class="form-select" id="filter_kelas" name="filter_kelas">
                            <option value="">-- Semua Kelas --</option>
                            {% for k in semua_kelas %}
                            <option value="{{ k }}" {% if filter_kelas == k %}selected{% endif %}>{{ k }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('siswa') }}" class="btn btn-danger me-auto">Reset Filter</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-dark">Cari</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const siswaModal = document.getElementById('siswaModal');
        const modalTitle = document.getElementById('siswaModalLabel');
        const form = document.getElementById('siswaForm');
        const submitBtn = document.getElementById('submitBtn');
        const editIdInput = document.getElementById('edit-id');
        const nisInput = document.getElementById('nis-input');
        const namaInput = document.getElementById('nama-input');
        const kelasInput = document.getElementById('kelas-input');
        const noHpInput = document.getElementById('no-hp-input');

        // Menyiapkan modal untuk mode Tambah atau Edit
        siswaModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Tombol yang memicu modal

            // Cek apakah tombol Edit yang diklik
            if (button && button.classList.contains('btn-edit-siswa')) {
                // Mode Edit
                modalTitle.textContent = 'Edit Data Siswa';
                submitBtn.textContent = 'Simpan Perubahan';

                // Mengisi form dengan data dari data-attribute tombol
                editIdInput.value = button.getAttribute('data-id');
                nisInput.value = button.getAttribute('data-nis');
                namaInput.value = button.getAttribute('data-nama');
                kelasInput.value = button.getAttribute('data-kelas');
                noHpInput.value = button.getAttribute('data-nohp');

            } else {
                // Mode Tambah
                modalTitle.textContent = 'Tambah Data Siswa';
                submitBtn.textContent = 'Tambahkan Siswa';

                // Mengosongkan form
                editIdInput.value = '';
                nisInput.value = '';
                namaInput.value = '';
                kelasInput.value = '';
                noHpInput.value = '';
            }
        });
    });
</script>
{% endblock %}