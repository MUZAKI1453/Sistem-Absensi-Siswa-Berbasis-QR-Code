{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <div class="scanner-card">
        <h3 class="mb-3">Scan QR Code untuk Absen</h3>
        <p class="text-muted">Arahkan kamera ke QR Code siswa.</p>

        <!-- Tempat Pemindai QR akan ditampilkan -->
        <div id="reader"></div>

        <!-- Kotak pesan untuk menampilkan status absensi -->
        <div id="message-box" class="alert d-none mt-3" role="alert"></div>

        <!-- Loading spinner yang akan muncul saat memproses -->
        <div id="loading-spinner" class="spinner-border text-primary d-none mt-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<style>
    .scanner-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 30px;
        text-align: center;
        max-width: 500px;
        width: 100%;
        margin: auto; /* Memastikan box berada di tengah */
    }
    #reader {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    #message-box {
        min-height: 40px;
        font-weight: 600;
        padding: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
    }
</style>

<!-- Library Html5Qrcode -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    const messageBox = document.getElementById('message-box');
    const loadingSpinner = document.getElementById('loading-spinner');

    function showMessage(type, message) {
        let alertClass = '';
        if (type === 'success') {
            alertClass = 'alert-success';
        } else if (type === 'error') {
            alertClass = 'alert-danger';
        } else if (type === 'warning') {
            alertClass = 'alert-warning';
        } else {
            alertClass = 'alert-secondary';
        }
        messageBox.className = `alert ${alertClass}`;
        messageBox.textContent = message;
        messageBox.classList.remove('d-none');
    }

    function onScanSuccess(decodedText) {
        html5QrcodeScanner.pause();
        messageBox.classList.add('d-none');
        loadingSpinner.classList.remove('d-none');

        fetch("/submit_scan", {
            method: "POST",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: "nis=" + decodedText
        })
        .then(res => res.json())
        .then(data => {
            showMessage(data.status, data.message);
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('error', 'Terjadi kesalahan. Silakan coba lagi.');
        })
        .finally(() => {
            loadingSpinner.classList.add('d-none');
            setTimeout(() => {
                html5QrcodeScanner.resume();
            }, 2000); // Lanjutkan setelah 2 detik
        });
    }

    function onScanFailure(error) {
        // Biarkan kosong agar error tidak muncul di console
    }

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: 250,
        rememberLastUsedCamera: true
    });

    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}
